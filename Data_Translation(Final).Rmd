---
title: "Data Translation Project"
author: "Group 7"
date: "March 15, 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r cars}
library(tidyverse)
library(vtable)
library(lubridate)
library(fixest)
library(jtools)
library(car)
library(lmtest)
library(ggpubr)
library(effects)
library(haven)
```


```{r}
rawdata <- read_dta("./cps_00005.dta")

indnamelink <- read_csv("./indnames.csv")

rawlinkedup <- rawdata %>% left_join(indnamelink, by = "ind")
```


Important variables and their values: 

covidunaw (Unable to work due to Covid): No = 1, Yes = 2

Employment status: Armed forces = 1 , At work = 10, has job not work last week = 12, Unemployed experienced worker = 21, unemployed new worker = 22, Not in labor force = 30-36 

Sex: Male = 1, Female = 2

Race: White = 100, Black = 200, American Indian = 300, Asian/Pacific Islander = 650 (651 Asian Only 652 Pacific Islander Only). Discussion about multi race

marst (marital status): married spouse present = 1, married spouse absent = 2, separated = 3, divorced = 4, widowed = 5, single = 6


```{r}
rawlinkedup <- rawlinkedup %>% mutate(yearmonth = make_date(year = rawlinkedup$year, month = rawlinkedup$month))

fulldata <- rawlinkedup %>% mutate(aftercovid = ifelse(yearmonth > as_date("2020-03-01"),1,0))

fulldata <- fulldata %>% mutate(working = ifelse(empstat == 10,1,0))

fulldata <- fulldata %>% mutate(retail = indname == 'Retail Trade')

fulldata <- fulldata %>% mutate(male = sex == 1)

fulldata <- fulldata %>% mutate(young = age <= 41)

fulldata <- fulldata %>% mutate(earnweek = ifelse(earnweek > 9999, NA_real_, earnweek))

fulldata <- fulldata %>% mutate(marst = ifelse(marst > 8, NA_real_, marst))

fulldata <- fulldata %>% mutate(race = ifelse(race > 831, NA_real_, race))

fulldata <- fulldata %>% mutate(covidunaw = ifelse(covidunaw > 98, NA_real_, covidunaw))

fulldata <- fulldata %>% mutate(covidlook = ifelse(covidlook > 98, NA_real_, covidlook))
```


The above code is used to manipulate the data set in order to create variables for the models we'll build. Specifically, we created a "yearmonth" variable to assign a time for each observation in a year-month format. We also use "mutate" to create a number of variables that we plan to use in our regression models in order to explain changes in employment and earnings before and after Covid.

We'd like to note that we turned the variable "age" into a binary variable (called *young*) to make it easier to work with in our models. We use the age 41 as a cutoff for young vs. old workers (i.e., age > 41 old workers, age =< 41 young workers). The assumption here is that if a worker is 41 or younger, then they are a millennial or Gen Z, which can both be considered groups of young people. The earning patterns between young and old workers differ, so in our models, we'd like to see how Covid affected the earnings of young people vs old people.


```{r}
model1 <- fulldata %>% feols(working ~ aftercovid:retail|yearmonth)

model2 <- lm(working ~ aftercovid*retail, data = fulldata)

export_summs(model1, model2, digits = 8, model.names = c("feols on working controlling for variation within time","lm on working with aftercovid*retail"))
```


The above code shows model 1, which is a fixed effects model showing employment trends while controlling for variation within time, and model 2, a multivariate regression model showing the difference in employment trends before and after Covid in the retail industry. The results of the regression models are shown in the table above. 


```{r}
model3 <- lm(working ~ aftercovid*retail + young, data = fulldata)

model4 <- lm(working ~ aftercovid*retail + male, data = fulldata)

model5 <- lm(working ~ aftercovid*retail + young + male, data = fulldata)

export_summs(model2, model3, model4, model5, digits = 8, model.names = c("lm on working with aftercovid*retail","lm on working aftercovid*retail control for age","lm on working aftercovid*retail control for sex","lm on working aftercovid*retail control for age and sex"))

model6 <- lm(earnweek ~ aftercovid*young, data = fulldata)

model6youngbinary <- lm(earnweek ~ aftercovid*young, data = fulldata)

model7 <- lm(earnweek ~ aftercovid*male, data = fulldata)

export_summs(model6, model7, digits = 8, model.names = c("lm on earnweek with aftercovid*age","lm on earnweek with aftercovid*male"))
```


Model 3: a multivariate regression model showing the difference in employment trends before and after Covid in the retail industry controlling for age. 

Model 4: a multivariate regression model showing the difference in employment trends before and after Covid in the retail industry controlling for sex. 

Model 5: a multivariate regression model showing the difference in employment trends before and after Covid in the retail industry controlling for age and sex. 

Model 6: a multivariate regression model showing the difference in earning trends by age before and after Covid.

Model 7: a multivariate regression model showing the difference in earning trends by sex before and after Covid.

The results of the regression models are shown in the tables above.


```{r}
bptest(model2)
bptest(model3)
bptest(model4)
bptest(model5)
bptest(model6)
bptest(model7)

linearHypothesis(model2,c("aftercovid=0","retailTRUE=0","aftercovid:retailTRUE=0"))

linearHypothesis(model3,c("aftercovid=0","retailTRUE=0","aftercovid:retailTRUE=0","youngTRUE=0"))

linearHypothesis(model4,c("aftercovid=0","retailTRUE=0","aftercovid:retailTRUE=0","maleTRUE=0"))

linearHypothesis(model5,c("aftercovid=0","retailTRUE=0","aftercovid:retailTRUE=0","youngTRUE=0","maleTRUE=0"))

linearHypothesis(model6, c("aftercovid=0","youngTRUE=0","aftercovid:youngTRUE=0"))

linearHypothesis(model7,c("aftercovid=0","maleTRUE=0","aftercovid:maleTRUE=0"))
```


We use the Breusch-Pagan test above to check for Heteroscedasticity. The p-values here are far below 0.05, so we reject the null for the Breusch-Pagan test which is that the variance of the residuals is constant. Heteroscedasticity is present so we need robust standard errors. Additionally, the results for the hypothesis testing are statistically significant so we can reject the null.


```{r}
export_summs(model1, model2, digits = 8, model.names = c("feols on working controlling for variation withing time","lm on working with aftercovid*retail"), robust = TRUE, error_format = "[{conf.low}, {conf.high}], ({std.error})")

export_summs(model2, model3, model4, model5, digits = 8, model.names = c("lm on working with aftercovid*retail","lm on working aftercovid*retail control for age","lm on working aftercovid*retail control for sex","lm on working aftercovid*retail control for age and sex"), robust = TRUE, error_format = "[{conf.low}, {conf.high}], ({std.error})")

export_summs(model6, model7, digits = 8, model.names = c("lm on earnweek with aftercovid*age","lm on earnweek with aftercovid*male"), robust = TRUE, error_format = "[{conf.low}, {conf.high}], ({std.error})")
```


We present the results of our models in the tables above again; however, because we found that heteroscedasticity is present, we ensure this time around that the standard errors are heteroskedasticity robust.


```{r}
model2effect <- effect('aftercovid*retail', model2, se= TRUE)
plot(model2effect, multiline = TRUE)

model3effect <- effect('aftercovid*retail', model3, se= TRUE)
plot(model3effect, multiline = TRUE)

model4effect <- effect('aftercovid*retail', model4, se= TRUE)
plot(model4effect, multiline = TRUE)

model5effect <- effect('aftercovid*retail', model5, se= TRUE)
plot(model5effect, multiline = TRUE)

model6youngbinaryeffect <- effect('aftercovid*young', model6, se= TRUE)
plot(model6youngbinaryeffect, multiline = TRUE)

model7effect <- effect('aftercovid*male', model7, se= TRUE)
plot(model7effect, multiline = TRUE)

plot_coefs(model2, scales = "fixed", level = 0.025) + coord_flip()

plot_coefs(model3, scales = "fixed", level = 0.025) + coord_flip()

plot_coefs(model4, scales = "fixed", level = 0.025) + coord_flip()

plot_coefs(model5, scales = "fixed", level = 0.025) + coord_flip()

plot_coefs(model6, scales = "fixed", level = 0.025) + coord_flip()

plot_coefs(model6youngbinary, scales = "fixed", level = 0.025) + coord_flip()

plot_coefs(model7, scales = "fixed", level = 0.025) + coord_flip()
```


Above we plot our models to visually see the effects we're trying to understand through our models. In addition, we include confidence interval plots to accompany the effect graphs. 

